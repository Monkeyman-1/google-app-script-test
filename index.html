<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSONP Product Info</title>
</head>
<body>

    <h1>Raw Product Information from Google Sheet (JSONP)</h1>
    <p>This page uses JSONP to fetch data, bypassing typical CORS restrictions.</p>
    <hr>

    <button id="refreshButton">Refresh Raw Data (JSONP)</button>

    <div id="product-container">
        Loading data...
    </div>

    <div id="error-message" style="color: red; margin-top: 10px; border: 1px solid red; padding: 5px;"></div>

    <script>
        // Your deployed Google Apps Script Web App URL (for JSONP)
        // Ensure this is the URL from your Apps Script deployed with the JSONP code.
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbw6iKxCi4wXTysVJ-nAwIhp0V0-BZj_aYTJIOF8g9W0JxIRhymK2OEGG2f0SS4MvB4zXw/exec'; // This should be updated if you create a new script

        const productContainer = document.getElementById('product-container');
        const refreshButton = document.getElementById('refreshButton');
        const errorMessage = document.getElementById('error-message');

        // This function will be called by the JSONP response
        function handleProductData(data) {
            productContainer.textContent = ''; // Clear loading message

            if (data.error) {
                errorMessage.textContent = `Apps Script Error: ${data.error}`;
                console.error("Apps Script Error:", data.error);
                return;
            }
            if (data.message) {
                productContainer.textContent = `Message from Script: ${data.message}`;
                return;
            }
            if (data.length === 0) {
                productContainer.textContent = 'No product data received (empty array).';
                return;
            }

            // Display each item and all its variables
            data.forEach((item, index) => {
                const div = document.createElement('div');
                div.style.marginBottom = '15px';
                div.style.border = '1px solid #ccc';
                div.style.padding = '10px';

                const itemTitle = document.createElement('h3');
                itemTitle.textContent = `Item ${index + 1}:`;
                div.appendChild(itemTitle);

                const ul = document.createElement('ul');
                ul.style.listStyleType = 'none';
                ul.style.paddingLeft = '0';

                Object.entries(item).forEach(([key, value]) => {
                    const li = document.createElement('li');
                    li.textContent = `Key: "${key}" | Value: "${value}" (Type: ${typeof value})`;
                    ul.appendChild(li);
                });
                div.appendChild(ul);
                productContainer.appendChild(div);
            });
            console.log("JSONP data fetched and displayed successfully:", data);
        }

        /**
         * Fetches product data using JSONP.
         */
        function fetchProductsJSONP() {
            productContainer.textContent = 'Loading data...';
            errorMessage.textContent = '';

            // Generate a unique callback name
            const callbackName = 'jsonpCallback_' + Date.now();

            // Create a script element
            const script = document.createElement('script');
            script.src = `${WEB_APP_URL}?callback=${callbackName}`; // Pass callback function name as URL parameter
            script.onerror = () => {
                errorMessage.textContent = 'Error loading JSONP script. Check network or Apps Script URL.';
                console.error("JSONP script failed to load.");
            };

            // Assign the callback function globally so the script can call it
            window[callbackName] = (data) => {
                handleProductData(data); // Call our handler
                delete window[callbackName]; // Clean up global function
                document.body.removeChild(script); // Remove script element
            };

            // Append the script element to the body to trigger the request
            document.body.appendChild(script);
        }

        // Add event listener to the refresh button
        refreshButton.addEventListener('click', fetchProductsJSONP);

        // Fetch data when the page loads
        document.addEventListener('DOMContentLoaded', fetchProductsJSONP);
    </script>
</body>
</html>
