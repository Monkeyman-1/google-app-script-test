<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Information</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-4xl">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Product Dashboard</h1>
            <p class="text-gray-600 mt-1">Fetching live product data from a Google Sheet using JSONP.</p>
        </header>

        <!-- Control Panel -->
        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 mb-6 flex items-center justify-between">
            <h2 class="text-lg font-semibold">Product Data</h2>
            <button id="refreshButton" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition-colors duration-300">
                Refresh Data
            </button>
        </div>

        <!-- Error and Message Display -->
        <div id="message-area" class="hidden my-4 p-4 rounded-lg"></div>

        <!-- Product Container -->
        <div id="product-container" class="space-y-4">
            <!-- Loading State -->
            <div id="loading-state" class="text-center py-10">
                <p class="text-gray-500">Loading data...</p>
            </div>
        </div>
    </div>

    <script>
        // IMPORTANT: Replace this with the NEW URL from your deployed Google Apps Script.
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyCBBLg4ghhPkKoJ_kY-FfoQAXj-vv8I6W4vPzKSqA_UcuEUSOhVPsm3fWI4X_OlBMAdw/exec';

        const productContainer = document.getElementById('product-container');
        const refreshButton = document.getElementById('refreshButton');
        const messageArea = document.getElementById('message-area');
        const loadingState = document.getElementById('loading-state');

        /**
         * Displays a message, error, or notification to the user.
         * @param {string} text - The message to display.
         * @param {'error' | 'success' | 'info'} type - The type of message.
         */
        function showMessage(text, type = 'info') {
            messageArea.textContent = text;
            messageArea.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');
            if (type === 'error') {
                messageArea.classList.add('bg-red-100', 'text-red-700');
            } else if (type === 'success') {
                messageArea.classList.add('bg-green-100', 'text-green-700');
            } else {
                messageArea.classList.add('bg-gray-100', 'text-gray-700');
            }
            messageArea.classList.remove('hidden');
        }

        /**
         * This function is the JSONP callback, executed by the script from Google.
         * @param {object} response - The data object from the Google Apps Script.
         */
        function handleProductData(response) {
            loadingState.style.display = 'none'; // Hide loading indicator
            productContainer.innerHTML = ''; // Clear previous content

            // Check for an error from the Apps Script itself
            if (response.error) {
                showMessage(`Apps Script Error: ${response.error}`, 'error');
                console.error("Apps Script Error:", response.error);
                return;
            }

            // Check for a message (e.g., "No data available")
            if (response.message) {
                showMessage(`Message from Script: ${response.message}`, 'info');
                return;
            }
            
            // Check if the data is not an array or is empty
            if (!Array.isArray(response) || response.length === 0) {
                showMessage('No product data was returned. The sheet might be empty.', 'info');
                return;
            }

            // If we have data, display it
            showMessage(`Successfully loaded ${response.length} items.`, 'success');

            response.forEach(item => {
                const card = document.createElement('div');
                card.className = 'bg-white border border-gray-200 rounded-lg shadow-sm p-5 transform hover:scale-101 transition-transform duration-300';

                const ul = document.createElement('ul');
                ul.className = 'space-y-2';

                Object.entries(item).forEach(([key, value]) => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center';
                    
                    const keySpan = document.createElement('span');
                    keySpan.className = 'font-semibold text-gray-700 capitalize';
                    keySpan.textContent = key.replace(/([A-Z])/g, ' $1'); // Add space before caps for better reading
                    
                    const valueSpan = document.createElement('span');
                    valueSpan.className = 'text-gray-600 bg-gray-100 px-2 py-1 rounded';
                    valueSpan.textContent = value;

                    li.appendChild(keySpan);
                    li.appendChild(valueSpan);
                    ul.appendChild(li);
                });

                card.appendChild(ul);
                productContainer.appendChild(card);
            });
            console.log("JSONP data fetched and displayed successfully:", response);
        }

        /**
         * Fetches product data using the JSONP technique.
         */
        function fetchProductsJSONP() {
            productContainer.innerHTML = ''; // Clear old results
            loadingState.style.display = 'block'; // Show loading
            messageArea.classList.add('hidden'); // Hide old messages

            // Generate a unique callback name to avoid conflicts and cache issues
            const callbackName = 'jsonpCallback_' + Date.now();

            // Create a new script element for the JSONP request
            const script = document.createElement('script');
            script.src = `${WEB_APP_URL}?callback=${callbackName}`;

            // Handle script loading errors (e.g., network issue, invalid URL, or permissions error)
            script.onerror = () => {
                showMessage('Failed to load the script. Check the Web App URL and deployment permissions (must be "Anyone").', 'error');
                console.error("JSONP script failed to load. This is often due to incorrect deployment permissions on the Google Apps Script.");
                loadingState.style.display = 'none';
                
                // Clean up the failed script and callback
                delete window[callbackName];
                if (script.parentNode) {
                    script.parentNode.removeChild(script);
                }
            };

            // Assign the callback function to the global window object
            // This makes it accessible to the script returned from Google
            window[callbackName] = (data) => {
                handleProductData(data); // Process the received data

                // Clean up after execution
                delete window[callbackName];
                if (script.parentNode) {
                    script.parentNode.removeChild(script);
                }
            };

            // Append the script to the document head to trigger the request
            document.head.appendChild(script);
        }

        // Add event listener to the refresh button
        refreshButton.addEventListener('click', fetchProductsJSONP);

        // Fetch data automatically when the page first loads
        document.addEventListener('DOMContentLoaded', fetchProductsJSONP);
    </script>
</body>
</html>
